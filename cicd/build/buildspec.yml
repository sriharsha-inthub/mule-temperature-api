version: 0.2

env:
  variables:
    JAVA_HOME: "/usr/lib/jvm/java-8-openjdk-amd64"
  parameter-store:
    CLOUDHUB_USERNAME: /CodeBuild/user
    CLOUDHUB_PASSWORD: /CodeBuild/pass
phases:
  install:
    run-as: root
    runtime-versions:
      java: openjdk8
    commands:
      - echo "Installing maven..."
      - apt-get update -y
      - apt-get install -y maven
    finally:
      - echo "End of install phase."
  pre_build:
    run-as: root
    commands:
      - echo "Mule app - temperature-api - Build Initiated... "
      - echo "Build [pre_build] phase started..."
      - java -version && mvn -version
      - echo "Build [pre_build] phase completed..."
    finally:
      - echo "End of pre-build phase."
  build:
    run-as: root
    commands:
      - echo "Build [build] phase started..."
      - mvn clean install -DskipTests
      - echo "Build [build] phase completed..."
    finally:
      - echo "End of build phase."
  post_build:
    run-as: root
    commands:
      - echo "Build [post_build] phase started..."
      - echo "Deploying to CLoudHub with credentials stored in parameter store"
      - mvn -DskipTests -DmuleDeploy -Dmule.RuntimeVersion=4.1.5 -Danypoint.env=Sandbox -Dcloudhub.appName=mule-temp-api-v1 -Dcloudhub.username=$/CodeBuild/user -Dcloudhub.password=$/CodeBuild/pass deploy
      - echo "Build [post_build] phase completed..."
    finally:
      - echo "End of post-build phase."  
artifacts:
  files:
    - target/temperature-api-1.0.0-mule-application.jar
  discard-paths: yes

cache:
  paths:
    - '/root/.m2/**/*'
